<!DOCTYPE html>
<html>
<head>
    <title>Debug Storage - AI Virtual Try-On</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug-output { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>Storage Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Storage Manager Status</h3>
        <button id="check-storage-btn">Check Storage Manager</button>
        <div id="storage-status" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>Photos in Storage</h3>
        <button id="check-photos-btn">Check Photos</button>
        <button id="clear-photos-btn">Clear All Photos</button>
        <div id="photos-status" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h3>LocalStorage Fallback</h3>
        <button id="check-localstorage-btn">Check LocalStorage</button>
        <button id="clear-localstorage-btn">Clear LocalStorage</button>
        <div id="localstorage-status" class="debug-output"></div>
    </div>

    <script src="lib/storage-manager.js"></script>
    <script>
        async function checkStorageManager() {
            const output = document.getElementById('storage-status');
            
            try {
                output.innerHTML = 'Checking storage manager...<br>';
                
                if (window.storageManager) {
                    output.innerHTML += '‚úÖ Storage manager exists<br>';
                    
                    if (window.storageManagerReady) {
                        output.innerHTML += '‚è≥ Waiting for storage manager to be ready...<br>';
                        await window.storageManagerReady;
                        output.innerHTML += '‚úÖ Storage manager is ready<br>';
                    }
                    
                    if (window.storageManager.db) {
                        output.innerHTML += '‚úÖ Database connection exists<br>';
                    } else {
                        output.innerHTML += '‚ùå No database connection<br>';
                    }
                } else {
                    output.innerHTML += '‚ùå Storage manager not found<br>';
                }
            } catch (error) {
                output.innerHTML += `‚ùå Error: ${error.message}<br>`;
            }
        }
        
        async function checkPhotos() {
            const output = document.getElementById('photos-status');
            
            try {
                output.innerHTML = 'Checking photos...<br>';
                
                if (window.storageManager && window.storageManager.db) {
                    const photos = await window.storageManager.getUserPhotos();
                    output.innerHTML += `üì∏ Found ${photos ? photos.length : 0} photos in IndexedDB<br>`;
                    
                    if (photos && photos.length > 0) {
                        photos.forEach((photo, index) => {
                            output.innerHTML += `  ${index + 1}. ${photo.filename} (${photo.id})<br>`;
                        });
                    }
                } else {
                    output.innerHTML += '‚ùå Storage manager not available<br>';
                }
            } catch (error) {
                output.innerHTML += `‚ùå Error: ${error.message}<br>`;
            }
        }
        
        async function clearPhotos() {
            const output = document.getElementById('photos-status');
            
            try {
                if (window.storageManager && window.storageManager.db) {
                    await window.storageManager.clearAllData();
                    output.innerHTML = 'üóëÔ∏è All photos cleared from IndexedDB<br>';
                } else {
                    output.innerHTML = '‚ùå Storage manager not available<br>';
                }
            } catch (error) {
                output.innerHTML = `‚ùå Error: ${error.message}<br>`;
            }
        }
        
        function checkLocalStorage() {
            const output = document.getElementById('localstorage-status');
            
            try {
                const savedPhotos = localStorage.getItem('vto-photos');
                if (savedPhotos) {
                    const photos = JSON.parse(savedPhotos);
                    output.innerHTML = `üì∏ Found ${photos.length} photos in localStorage<br>`;
                    
                    photos.forEach((photo, index) => {
                        output.innerHTML += `  ${index + 1}. ${photo.filename}<br>`;
                    });
                } else {
                    output.innerHTML = 'üì≠ No photos in localStorage<br>';
                }
            } catch (error) {
                output.innerHTML = `‚ùå Error: ${error.message}<br>`;
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('vto-photos');
            document.getElementById('localstorage-status').innerHTML = 'üóëÔ∏è LocalStorage cleared<br>';
        }
        
        // Add event listeners
        document.getElementById('check-storage-btn').addEventListener('click', checkStorageManager);
        document.getElementById('check-photos-btn').addEventListener('click', checkPhotos);
        document.getElementById('clear-photos-btn').addEventListener('click', clearPhotos);
        document.getElementById('check-localstorage-btn').addEventListener('click', checkLocalStorage);
        document.getElementById('clear-localstorage-btn').addEventListener('click', clearLocalStorage);

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkStorageManager();
                checkPhotos();
                checkLocalStorage();
            }, 500);
        });
    </script>
</body>
</html>
